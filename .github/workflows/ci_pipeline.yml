name: CI Pipeline

on:
  pull_request:
    branches:
      - develop
      - release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ”¥ google-services.json íŒŒì¼
      - name: Restore google-services.json
        env:
          DATA_ANDROID: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: echo "$DATA_ANDROID" > android/app/google-services.json

      # ğŸ”¥ .env.dev íŒŒì¼ ìƒì„±
      - name: Create .env.dev file
        run: echo "${{ secrets.ENV_DEV }}" > .env.dev

      # ğŸ”¥ .env.prod íŒŒì¼ ìƒì„±
      - name: Create .env.prod file
        run: echo "${{ secrets.ENV_PROD }}" > .env.prod

      # ğŸ”¥ Flutter SDK ì„¤ì¹˜ ë° ìºì‹œ í™œì„±í™”
      - name: Install Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          cache: true

      # ğŸ”¥ Flutter ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Flutter dependencies
        run: flutter pub get

      # ğŸ”¥ ë¦°íŠ¸ ì²´í¬
      - name: Flutter lint check
        run: flutter analyze

      # ğŸ”¥ Android ë¹Œë“œ
      - name: Build Android Debug APK
        run: flutter build apk --debug

  ios_build:
    runs-on: macos-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

#      # Flutter SDK ìºì‹œ ì„¤ì •
#      - name: Cache Flutter SDK
#        uses: actions/cache@v2
#        with:
#          path: ~/.pub-cache
#          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
#          restore-keys: |
#            ${{ runner.os }}-flutter-

      # ğŸ”¥ Flutter SDK ì„¤ì¹˜ ë° ìºì‹œ í™œì„±í™”
      - name: Install Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'

      # ğŸ”¥ GoogleService-Info.plist íŒŒì¼
      - name: Restore GoogleService-Info.plist
        env:
          DATA_IOS: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}
        run: echo "$DATA_IOS" > ios/Runner/GoogleService-Info.plist

      # ğŸ”¥ .env.dev íŒŒì¼ ìƒì„±
      - name: Create .env.dev file
        run: echo "${{ secrets.ENV_DEV }}" > .env.dev
      
      # ğŸ”¥ .env.prod íŒŒì¼ ìƒì„±
      - name: Create .env.prod file
        run: echo "${{ secrets.ENV_PROD }}" > .env.prod

      # ğŸ”¥ Flutter í´ë¦° ë° ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Clean and Install Flutter dependencies
        run: |
          flutter clean
          flutter pub get

      # ğŸ”¥ iOS ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install iOS dependencies
        run: |
          cd ios
          pod repo update
          pod install --repo-update
          pod update Firebase/CoreOnly
          cd ..

      # ğŸ”¥ iOS ë¹Œë“œ
      - name: Build iOS
        run: flutter build ios --no-codesign